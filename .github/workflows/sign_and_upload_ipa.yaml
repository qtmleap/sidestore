name: Sign and Upload IPA to R2

on:
  workflow_dispatch:
    inputs:
      certificate_type:
        description: "Certificate type for signing"
        required: false
        type: choice
        default: "adhoc"
        options:
          - adhoc
          - enterprise
          - appstore
      app_filter:
        description: "Filter apps by ID (comma-separated, empty for all)"
        required: false
        type: string

jobs:
  prepare:
    name: Prepare app matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set matrix
        id: set-matrix
        run: |
          # Read apps from JSON file
          if [ -n "${{ inputs.app_filter }}" ]; then
            # Filter by app IDs
            FILTER="${{ inputs.app_filter }}"
            MATRIX=$(jq -c --arg filter "$FILTER" '
              .apps | map(select(.id as $id | $filter | split(",") | map(gsub("\\s+"; "")) | index($id)))
            ' .github/apps.json)
          else
            # All apps
            MATRIX=$(jq -c '.apps' .github/apps.json)
          fi

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Apps to process:"
          echo "$MATRIX" | jq .

  sign-and-upload:
    name: Sign ${{ matrix.app.name }}
    needs: prepare
    runs-on: macos-14
    timeout-minutes: 30
    env:
      R2_BASE_URL: "https://app.qleap.jp"
      TEAM_ID: "5Q94QJ7G98"
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: false

      - name: Install fastlane
        run: |
          gem install fastlane --no-document
          fastlane --version

      - name: Download unsigned IPA from R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME || 'app-distribution' }}
        run: |
          mkdir -p unsigned signed

          # Download IPA directly from R2
          bunx wrangler r2 object get \
            "$R2_BUCKET/${{ matrix.app.id }}/${{ matrix.app.id }}.ipa" \
            --file unsigned/app.ipa \
            --remote

          echo "Downloaded IPA size: $(du -h unsigned/app.ipa | cut -f1)"

      - name: Sign IPA with fastlane
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: "https://x-access-token:${{ secrets.MATCH_GIT_TOKEN }}@github.com/qtmleap/match.git"
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        run: |
          mkdir -p signed

          fastlane ios sign_ipa \
            cert_type:"${{ inputs.certificate_type }}" \
            bundle_id:"${{ matrix.app.bundle_id }}" \
            team_id:"${TEAM_ID}" \
            ipa_path:"unsigned/app.ipa" \
            output_path:"signed/app.ipa"

          echo "✅ Signed IPA created"
          echo "Signed IPA size: $(du -h signed/app.ipa | cut -f1)"

      - name: Upload to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME || 'app-distribution' }}
        run: |
          bunx wrangler r2 object put \
            "$R2_BUCKET/${{ matrix.app.id }}/${{ matrix.app.id }}.ipa" \
            --file signed/app.ipa \
            --content-type "application/octet-stream" \
            --remote

          echo "✅ Uploaded: ${{ matrix.app.id }}/${{ matrix.app.id }}.ipa"

      - name: Summary
        run: |
          echo "## ✅ ${{ matrix.app.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App ID | ${{ matrix.app.id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle ID | ${{ matrix.app.bundle_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${R2_BASE_URL}/${{ matrix.app.id }}/${{ matrix.app.id }}.ipa |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -rf fastlane

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: signed-ipa-${{ matrix.app.id }}
          path: signed/app.ipa
          retention-days: 30
